import { useState, useMemo } from 'react';
import {
    Box, Paper, Typography,
    Table, TableBody, TableCell, TableContainer, TableHead, TableRow,
    TextField, ToggleButton, ToggleButtonGroup, Chip, Tooltip
} from '@mui/material';

import PublicIcon from '@mui/icons-material/Public';
import BugReportIcon from '@mui/icons-material/BugReport';
import CheckCircleOutlineIcon from '@mui/icons-material/CheckCircleOutline';
import ErrorOutlineIcon from '@mui/icons-material/ErrorOutline';
import AccessTimeIcon from '@mui/icons-material/AccessTime';
import KeyboardDoubleArrowUpIcon from '@mui/icons-material/KeyboardDoubleArrowUp';
import ScienceIcon from '@mui/icons-material/Science';
import AutoAwesomeIcon from '@mui/icons-material/AutoAwesome';
import FilterAltOffIcon from '@mui/icons-material/FilterAltOff';

import { useTheme } from '@mui/material/styles';
import { useStore } from '../../store';
import { demoData } from '../../data/demo_data';
import { transformVulnerabilityData } from '../../utils/dataTransformer';

const allRows = transformVulnerabilityData(demoData);

export const VulnerabilityList = () => {
    const theme = useTheme();
    const { selectedThreat, setSelectedThreat } = useStore();
    const [searchQuery, setSearchQuery] = useState('');
    const [severityFilter, setSeverityFilter] = useState<string | null>('All');
    const [topPriority, setTopPriority] = useState(false);

    // Assessment Filters
    const [isAnalysisActive, setIsAnalysisActive] = useState(false); // Filters 'invalid - norisk'
    const [isAiAnalysisActive, setIsAiAnalysisActive] = useState(false); // Filters 'ai-invalid-norisk'

    const handleSeverityChange = (_event: React.MouseEvent<HTMLElement>, newAlignment: string | null) => {
        if (newAlignment !== null) {
            setSeverityFilter(newAlignment);
        }
    };

    const filteredRows = useMemo(() => {
        const query = searchQuery.toLowerCase();

        return allRows.filter(row => {
            // Apply assessment filters (Noise reduction)
            if (isAnalysisActive && row.kaiStatus === 'invalid - norisk') return false;
            if (isAiAnalysisActive && row.kaiStatus === 'ai-invalid-norisk') return false;

            // Priority mode: Only show high-risk items
            if (topPriority) {
                const isSignificant = row.severity === 'Critical' || row.severity === 'High';
                if (!isSignificant || !row.exploitAvailable || !row.internetFacing) return false;
            }

            // Standard filters
            if (severityFilter !== 'All' && row.severity !== severityFilter) return false;
            if (query && !row.description.toLowerCase().includes(query) && !row.id.toLowerCase().includes(query)) return false;

            return true;
        });
    }, [searchQuery, severityFilter, topPriority, isAnalysisActive, isAiAnalysisActive]);

    const hiddenCount = allRows.length - filteredRows.length;

    return (
        <Paper sx={{
            height: '100%',
            width: '100%',
            background: 'rgba(5, 10, 20, 0.8)', // Darker background for readability
            borderTop: `2px solid ${theme.palette.primary.main}`,
            display: 'flex',
            flexDirection: 'column',
            overflow: 'hidden'
        }}>
            <Box sx={{ p: 2, borderBottom: '1px solid rgba(255,255,255,0.1)' }}>
                <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', mb: 1 }}>
                    <Typography variant="h6" color="primary">Active Vulnerabilities</Typography>
                    <Box sx={{ display: 'flex', alignItems: 'center', gap: 2 }}>
                        {hiddenCount > 0 && (
                            <Chip
                                icon={<FilterAltOffIcon sx={{ fontSize: '14px !important' }} />}
                                label={`${hiddenCount} Hidden`}
                                size="small"
                                sx={{ bgcolor: 'rgba(255,255,255,0.1)', color: 'text.secondary', height: 20, fontSize: '0.7rem' }}
                            />
                        )}
                        <Typography variant="caption" sx={{ color: 'text.secondary', display: 'flex', alignItems: 'center', gap: 0.5 }}>
                            <AccessTimeIcon sx={{ fontSize: 14 }} /> Synced: {allRows[0]?.lastSynced || 'Just now'}
                        </Typography>
                    </Box>
                </Box>

                <Box sx={{ display: 'flex', gap: 1, flexDirection: 'column' }}>
                    <TextField
                        size="small"
                        placeholder="Search vulnerabilities..."
                        variant="outlined"
                        value={searchQuery}
                        onChange={(e) => setSearchQuery(e.target.value)}
                        sx={{
                            '& .MuiOutlinedInput-root': {
                                color: 'white',
                                '& fieldset': { borderColor: 'rgba(255,255,255,0.2)' },
                                '&:hover fieldset': { borderColor: theme.palette.primary.main },
                            }
                        }}
                    />
                    <Box sx={{ display: 'flex', gap: 1, flexWrap: 'wrap' }}>
                        <ToggleButtonGroup
                            value={severityFilter}
                            exclusive
                            onChange={handleSeverityChange}
                            aria-label="severity filter"
                            size="small"
                            sx={{
                                '& .MuiToggleButton-root': {
                                    color: 'rgba(255,255,255,0.5)',
                                    borderColor: 'rgba(255,255,255,0.1)',
                                    '&.Mui-selected': {
                                        color: theme.palette.primary.main,
                                        bgcolor: 'rgba(0, 240, 255, 0.1)'
                                    }
                                }
                            }}
                        >
                            <ToggleButton value="All">All</ToggleButton>
                            <ToggleButton value="Critical" sx={{ color: '#FF003C !important' }}>Crit</ToggleButton>
                            <ToggleButton value="High" sx={{ color: '#FFEA00 !important' }}>High</ToggleButton>
                        </ToggleButtonGroup>

                        <Tooltip title="Top Priority (Exploitable + Internet Facing)">
                            <ToggleButton
                                value="check"
                                selected={topPriority}
                                onChange={() => setTopPriority(!topPriority)}
                                size="small"
                                sx={{
                                    color: topPriority ? '#fff !important' : 'rgba(255,255,255,0.5)',
                                    borderColor: topPriority ? '#FF003C !important' : 'rgba(255,255,255,0.1)',
                                    bgcolor: topPriority ? '#FF003C !important' : 'transparent',
                                    '&:hover': { bgcolor: topPriority ? '#d50032 !important' : 'rgba(255,0,60,0.1)' }
                                }}
                            >
                                <KeyboardDoubleArrowUpIcon sx={{ mr: 0.5, fontSize: 18 }} /> Priority
                            </ToggleButton>
                        </Tooltip>

                        <Box sx={{ width: '1px', bgcolor: 'rgba(255,255,255,0.1)', mx: 0.5 }} />

                        <Tooltip title="Filter 'invalid - norisk'">
                            <ToggleButton
                                value="analysis"
                                selected={isAnalysisActive}
                                onChange={() => setIsAnalysisActive(!isAnalysisActive)}
                                size="small"
                                sx={{
                                    color: isAnalysisActive ? '#fff !important' : 'rgba(255,255,255,0.5)',
                                    borderColor: isAnalysisActive ? theme.palette.primary.main : 'rgba(255,255,255,0.1)',
                                    bgcolor: isAnalysisActive ? `${theme.palette.primary.main}40` : 'transparent',
                                    '&:hover': { bgcolor: isAnalysisActive ? `${theme.palette.primary.main}60` : 'rgba(0,240,255,0.1)' }
                                }}
                            >
                                <ScienceIcon sx={{ mr: 0.5, fontSize: 18 }} /> Analysis
                            </ToggleButton>
                        </Tooltip>

                        <Tooltip title="Filter 'ai-invalid-norisk'">
                            <ToggleButton
                                value="ai-analysis"
                                selected={isAiAnalysisActive}
                                onChange={() => setIsAiAnalysisActive(!isAiAnalysisActive)}
                                size="small"
                                sx={{
                                    color: isAiAnalysisActive ? '#fff !important' : 'rgba(255,255,255,0.5)',
                                    borderColor: isAiAnalysisActive ? theme.palette.secondary.main : 'rgba(255,255,255,0.1)',
                                    bgcolor: isAiAnalysisActive ? `${theme.palette.secondary.main}40` : 'transparent',
                                    '&:hover': { bgcolor: isAiAnalysisActive ? `${theme.palette.secondary.main}60` : 'rgba(112,0,255,0.1)' }
                                }}
                            >
                                <AutoAwesomeIcon sx={{ mr: 0.5, fontSize: 18 }} /> AI Analysis
                            </ToggleButton>
                        </Tooltip>
                    </Box>
                </Box>
            </Box>
            <Box sx={{ flex: 1, overflow: 'auto' }}>
                <TableContainer>
                    <Table stickyHeader size="small">
                        <TableHead>
                            <TableRow>
                                <TableCell sx={{ bgcolor: 'rgba(0, 240, 255, 0.1)', color: 'primary.main', fontWeight: 'bold' }}>ID</TableCell>
                                <TableCell sx={{ bgcolor: 'rgba(0, 240, 255, 0.1)', color: 'primary.main', fontWeight: 'bold' }}>Severity</TableCell>
                                <TableCell sx={{ bgcolor: 'rgba(0, 240, 255, 0.1)', color: 'primary.main', fontWeight: 'bold' }}>Ctx</TableCell>
                                <TableCell sx={{ bgcolor: 'rgba(0, 240, 255, 0.1)', color: 'primary.main', fontWeight: 'bold' }}>Vulnerability</TableCell>
                                <TableCell sx={{ bgcolor: 'rgba(0, 240, 255, 0.1)', color: 'primary.main', fontWeight: 'bold' }}>SLA</TableCell>
                                <TableCell sx={{ bgcolor: 'rgba(0, 240, 255, 0.1)', color: 'primary.main', fontWeight: 'bold' }}>Owner</TableCell>
                            </TableRow>
                        </TableHead>
                        <TableBody>
                            {filteredRows.map((row) => (
                                <TableRow
                                    key={row.id}
                                    onClick={() => setSelectedThreat(row.id)}
                                    selected={selectedThreat === row.id}
                                    hover
                                    sx={{
                                        cursor: 'pointer',
                                        '&.Mui-selected': {
                                            backgroundColor: `${theme.palette.secondary.main}20 !important`,
                                        },
                                        '&:hover': {
                                            backgroundColor: `${theme.palette.secondary.main}10 !important`,
                                        }
                                    }}
                                >
                                    <TableCell sx={{ color: 'text.secondary' }}>{row.id}</TableCell>
                                    <TableCell>
                                        <Box sx={{
                                            color: (theme.palette.severity as any)[row.severity.toLowerCase()] || theme.palette.text.primary,
                                            fontWeight: 'bold'
                                        }}>
                                            {row.severity}
                                        </Box>
                                    </TableCell>
                                    <TableCell>
                                        <Box sx={{ display: 'flex', gap: 0.5 }}>
                                            {row.internetFacing && (
                                                <Tooltip title="Internet Facing">
                                                    <PublicIcon sx={{ fontSize: 16, color: 'primary.main' }} />
                                                </Tooltip>
                                            )}
                                            {row.exploitAvailable && (
                                                <Tooltip title="Exploit Available">
                                                    <BugReportIcon sx={{ fontSize: 16, color: 'severity.critical' }} />
                                                </Tooltip>
                                            )}
                                            {!row.internetFacing && !row.exploitAvailable && (
                                                <Typography variant="caption" color="text.secondary">-</Typography>
                                            )}
                                        </Box>
                                    </TableCell>
                                    <TableCell sx={{ color: 'text.primary' }}>
                                        {row.description}
                                        {row.assetCriticality === 'Critical' && (
                                            <Chip label="Critical Asset" size="small" sx={{ ml: 1, height: 16, fontSize: '0.6rem', bgcolor: 'rgba(255,0,0,0.2)', color: 'severity.critical' }} />
                                        )}
                                    </TableCell>
                                    <TableCell>
                                        <Tooltip title={`Due: ${row.dueDate}`}>
                                            <Chip
                                                icon={row.slaStatus === 'On Track' ? <CheckCircleOutlineIcon sx={{ fontSize: '12px !important' }} /> : <ErrorOutlineIcon sx={{ fontSize: '12px !important' }} />}
                                                label={row.slaStatus}
                                                size="small"
                                                sx={{
                                                    height: 20,
                                                    fontSize: '0.7rem',
                                                    bgcolor: row.slaStatus === 'Overdue' ? 'rgba(255,0,60,0.2)' : (row.slaStatus === 'At Risk' ? 'rgba(255,234,0,0.2)' : 'rgba(57,255,20,0.1)'),
                                                    color: row.slaStatus === 'Overdue' ? 'severity.critical' : (row.slaStatus === 'At Risk' ? 'severity.high' : 'severity.low'),
                                                    '& .MuiChip-icon': { color: 'inherit' }
                                                }}
                                            />
                                        </Tooltip>
                                    </TableCell>
                                    <TableCell sx={{ color: 'text.secondary' }}>{row.assigned}</TableCell>
                                </TableRow>
                            ))}
                        </TableBody>
                    </Table>
                </TableContainer>
            </Box>
        </Paper>
    );
};
