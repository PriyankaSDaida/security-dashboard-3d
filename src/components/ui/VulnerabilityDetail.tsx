import React from 'react';
import {
    Drawer, Box, Typography, IconButton, Chip, Divider, Button, Grid, Stack
} from '@mui/material';
import CloseIcon from '@mui/icons-material/Close';
import PublicIcon from '@mui/icons-material/Public';
import BugReportIcon from '@mui/icons-material/BugReport';
import CheckCircleOutlineIcon from '@mui/icons-material/CheckCircleOutline';
import ErrorOutlineIcon from '@mui/icons-material/ErrorOutline';
import VerifiedUserIcon from '@mui/icons-material/VerifiedUser';
import BugReportOutlinedIcon from '@mui/icons-material/BugReportOutlined';
import PersonIcon from '@mui/icons-material/Person';
import CalendarTodayIcon from '@mui/icons-material/CalendarToday';

import { useStore } from '../../store';
import { demoData } from '../../data/demo_data';
import { transformVulnerabilityData } from '../../utils/dataTransformer';
import { useTheme } from '@mui/material/styles';

const allRows = transformVulnerabilityData(demoData);

export const VulnerabilityDetail = () => {
    const theme = useTheme();
    const { selectedThreat, setSelectedThreat } = useStore();

    const threat = React.useMemo(() =>
        allRows.find(row => row.id === selectedThreat),
        [selectedThreat]);

    const handleClose = () => setSelectedThreat(null);

    if (!threat) return null;

    const getSeverityColor = (sev: string) => {
        switch (sev) {
            case 'Critical': return '#FF003C';
            case 'High': return '#FFEA00';
            case 'Medium': return '#FFA500';
            default: return '#39FF14';
        }
    };

    return (
        <Drawer
            anchor="right"
            open={!!selectedThreat}
            onClose={handleClose}
            PaperProps={{
                sx: {
                    width: '400px',
                    bgcolor: 'rgba(10, 25, 41, 0.95)',
                    backdropFilter: 'blur(10px)',
                    borderLeft: `1px solid ${theme.palette.primary.main}`,
                    color: 'white'
                }
            }}
        >
            <Box sx={{ p: 0, height: '100%', display: 'flex', flexDirection: 'column' }}>
                {/* Header */}
                <Box sx={{ p: 3, borderBottom: '1px solid rgba(255,255,255,0.1)', position: 'relative' }}>
                    <IconButton
                        onClick={handleClose}
                        sx={{ position: 'absolute', right: 8, top: 8, color: 'text.secondary' }}
                    >
                        <CloseIcon />
                    </IconButton>

                    <Typography variant="overline" color="text.secondary">VULNERABILITY DETAILS</Typography>
                    <Typography variant="h5" sx={{ color: theme.palette.primary.main, fontFamily: 'Orbitron, sans-serif' }}>
                        {threat.id}
                    </Typography>

                    <Box sx={{ mt: 1, display: 'flex', gap: 1 }}>
                        <Chip
                            label={threat.severity}
                            sx={{
                                bgcolor: `${getSeverityColor(threat.severity)}20`,
                                color: getSeverityColor(threat.severity),
                                fontWeight: 'bold',
                                border: `1px solid ${getSeverityColor(threat.severity)}`
                            }}
                        />
                        <Chip
                            label={threat.status}
                            sx={{ bgcolor: 'rgba(255,255,255,0.1)', color: 'white' }}
                        />
                    </Box>
                </Box>

                {/* Body */}
                <Box sx={{ p: 3, flex: 1, overflow: 'auto' }}>
                    <Box sx={{ mb: 4 }}>
                        <Typography variant="subtitle2" color="primary" sx={{ mb: 1 }}>DESCRIPTION</Typography>
                        <Typography variant="body2" color="text.secondary" sx={{ lineHeight: 1.6 }}>
                            {threat.description}
                        </Typography>
                    </Box>

                    <Divider sx={{ borderColor: 'rgba(255,255,255,0.1)', mb: 3 }} />

                    <Grid container spacing={2} sx={{ mb: 4 }}>
                        <Grid item xs={6}>
                            <Typography variant="caption" color="text.secondary">OWNER</Typography>
                            <Box sx={{ display: 'flex', alignItems: 'center', gap: 1, mt: 0.5 }}>
                                <PersonIcon sx={{ fontSize: 16 }} />
                                <Typography variant="body2">{threat.assigned}</Typography>
                            </Box>
                        </Grid>
                        <Grid item xs={6}>
                            <Typography variant="caption" color="text.secondary">DUE DATE</Typography>
                            <Box sx={{ display: 'flex', alignItems: 'center', gap: 1, mt: 0.5 }}>
                                <CalendarTodayIcon sx={{ fontSize: 16 }} />
                                <Typography variant="body2">{threat.dueDate}</Typography>
                            </Box>
                        </Grid>
                    </Grid>

                    <Typography variant="subtitle2" color="primary" sx={{ mb: 2 }}>RISK ASSESSMENT</Typography>
                    <Stack spacing={2}>
                        <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', bgcolor: 'rgba(255,255,255,0.05)', p: 1.5, borderRadius: 1 }}>
                            <Box sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
                                <PublicIcon sx={{ color: threat.internetFacing ? '#00F0FF' : 'grey' }} />
                                <Typography variant="body2">Internet Facing</Typography>
                            </Box>
                            <Typography variant="caption" color={threat.internetFacing ? "error" : "text.secondary"}>
                                {threat.internetFacing ? "YES" : "NO"}
                            </Typography>
                        </Box>

                        <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', bgcolor: 'rgba(255,255,255,0.05)', p: 1.5, borderRadius: 1 }}>
                            <Box sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
                                <BugReportIcon sx={{ color: threat.exploitAvailable ? '#FF003C' : 'grey' }} />
                                <Typography variant="body2">Exploit Available</Typography>
                            </Box>
                            <Typography variant="caption" color={threat.exploitAvailable ? "error" : "text.secondary"}>
                                {threat.exploitAvailable ? "YES" : "NO"}
                            </Typography>
                        </Box>

                        <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', bgcolor: 'rgba(255,255,255,0.05)', p: 1.5, borderRadius: 1 }}>
                            <Box sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
                                <Typography variant="body2" sx={{ ml: 0.5 }}>SLA Status</Typography>
                            </Box>
                            <Chip
                                icon={threat.slaStatus === 'On Track' ? <CheckCircleOutlineIcon /> : <ErrorOutlineIcon />}
                                label={threat.slaStatus}
                                size="small"
                                sx={{
                                    height: 20,
                                    fontSize: '0.7rem',
                                    bgcolor: threat.slaStatus === 'Overdue' ? 'rgba(255,0,60,0.2)' : (threat.slaStatus === 'At Risk' ? 'rgba(255,234,0,0.2)' : 'rgba(57,255,20,0.1)'),
                                    color: threat.slaStatus === 'Overdue' ? '#ff4d6d' : (threat.slaStatus === 'At Risk' ? '#fff9b0' : '#b0ffb0'),
                                }}
                            />
                        </Box>

                        {/* Kai Status Assessment */}
                        <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', bgcolor: 'rgba(255,255,255,0.05)', p: 1.5, borderRadius: 1 }}>
                            <Box sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
                                <Typography variant="body2" sx={{ ml: 0.5 }}>Kai Status</Typography>
                            </Box>
                            <Chip
                                label={threat.kaiStatus}
                                variant="outlined"
                                size="small"
                                sx={{ height: 20, fontSize: '0.7rem', borderColor: 'rgba(255,255,255,0.3)', color: 'text.secondary' }}
                            />
                        </Box>
                    </Stack>
                </Box>

                {/* Footer Actions */}
                <Box sx={{ p: 3, borderTop: '1px solid rgba(255,255,255,0.1)', display: 'flex', gap: 2 }}>
                    <Button
                        variant="contained"
                        color="primary"
                        fullWidth
                        startIcon={<VerifiedUserIcon />}
                        sx={{ fontWeight: 'bold' }}
                    >
                        Assign To Me
                    </Button>
                    <Button
                        variant="outlined"
                        color="error"
                        fullWidth
                        startIcon={<BugReportOutlinedIcon />}
                    >
                        Mark Fixed
                    </Button>
                </Box>
            </Box>
        </Drawer>
    );
};
